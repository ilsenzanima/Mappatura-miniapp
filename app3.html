<!DOCTYPE html>
<html class="dark" lang="it">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Segnalazione Intervento</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        iosBlue: "#007AFF",
                        iosBg: "#F2F2F7",
                        iosGrayText: "#8E8E93",
                        iosInputBg: "#F2F2F7",
                        primary: "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922"
                    },
                    fontFamily: {
                        sans: ["-apple-system", "BlinkMacSystemFont", "\"Segoe UI\"", "Roboto", "Helvetica", "Arial", "sans-serif"],
                        display: "Inter"
                    },
                    borderRadius: {
                        DEFAULT: "0.25rem",
                        lg: "0.5rem",
                        xl: "0.75rem",
                        full: "9999px"
                    }
                }
            }
        };
    </script>
    <style data-purpose="form-controls">
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url(https://lh3.googleusercontent.com/aida-public/AB6AXuA2HKMH8B47wUh6eZWhCf-7HI3dp1zvHci7Mt8cP2xmIg9qqKbEB5vCnTIrjLguAifjkT2m6bbQ342TgsaxEQd_WCe5oGz9MAFT4fjtHXQRwQZ7W6KnMyJuLcLiIf0a8Lp7rXI54pVDLktBOFtOPTWlxGh6WXffTk-Wepo9bKr4vfvlYsSBHtRC_M9numKLlyRjBdVZAZq_v9-2PQXiIiZ70zVZYszHpTIuEzTYADHSeumwG6vaIhll6mOG56XDf364sM-4E6WsNM6M);
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: none;
            background-color: #E5E5EA;
        }
        /* Camera Overlay Styles */
        .camera-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .camera-overlay.active { display: flex; }
        .camera-container { display: flex; flex-direction: column; gap: 10px; align-items: center; width: 100%; max-width: 640px; padding: 20px; }
        #camera-video { width: 100%; height: auto; border-radius: 8px; background: #000; }
        .overlay-controls { display: flex; gap: 10px; justify-content: center; width: 100%; margin-top: 20px; }
        .overlay-btn { padding: 12px 24px; border-radius: 9999px; font-weight: 600; color: white; background-color: #007AFF; border: none; cursor: pointer; }
        .overlay-btn.secondary { background-color: #8E8E93; }
        
        /* Preview container */
        #photo-preview { display: none; margin-top: 10px; border-radius: 12px; overflow: hidden; justify-content: center; background: #f0f0f0; }
        #photo-preview.active { display: flex; }
        #photo-preview img { max-width: 100%; max-height: 300px; object-fit: contain; }
    </style>
</head>
<body class="bg-iosBg font-sans antialiased text-black">
    <main class="max-w-md mx-auto min-h-screen px-4 pb-8 box-border">
        <!-- Header -->
        <header class="flex items-center justify-between py-4 mb-2 sticky top-0 bg-iosBg z-10">
            <button class="focus:outline-none p-2 -ml-2" onclick="window.history.back()">
                <i class="fas fa-chevron-left text-iosBlue text-xl"></i>
            </button>
            <h1 class="text-[1.1rem] font-bold">Segnalazione Intervento</h1>
            <button id="header-submit-btn" class="text-iosBlue text-base font-normal p-2 -mr-2">
                Invia
            </button>
        </header>

        <form id="report-form">
            <!-- Foto Section -->
            <section class="mb-6">
                <h2 class="font-bold text-base mb-2.5">Allega Foto</h2>
                
                <!-- Hidden file input -->
                <input type="file" id="photo" name="photo" accept="image/*" class="hidden" required>
                
                <div class="grid grid-cols-2 gap-4">
                    <button type="button" id="camera-btn" class="bg-white border-2 border-iosBlue rounded-xl py-5 flex flex-col items-center justify-center text-iosBlue shadow-sm active:bg-blue-50 transition-colors">
                        <i class="fas fa-camera fa-2x mb-2"></i>
                        <span class="font-medium">Fotocamera</span>
                    </button>
                    <button type="button" id="gallery-btn" class="bg-white border-2 border-iosBlue rounded-xl py-5 flex flex-col items-center justify-center text-iosBlue shadow-sm active:bg-blue-50 transition-colors">
                        <i class="fas fa-images fa-2x mb-2"></i>
                        <span class="font-medium">Galleria</span>
                    </button>
                </div>
                
                <div id="photo-preview" class="mt-4"></div>
                <div id="status" class="text-center text-sm font-medium mt-2 text-iosBlue"></div>
                
                <p class="text-center text-iosGrayText text-xs mt-2.5 mb-5">
                    Tocca per aggiungere foto
                </p>
            </section>

            <!-- Dettagli Posizione -->
            <section class="bg-white rounded-xl p-4 mb-5 shadow-sm">
                <h2 class="font-bold text-lg mb-4">Dettagli Posizione</h2>
                
                <div class="flex items-center justify-between mb-3">
                    <label class="w-[35%] font-medium text-sm" for="piano-select">Piano</label>
                    <div class="w-[60%]">
                        <select class="w-full bg-iosInputBg border-none rounded-lg py-2 px-3 text-sm text-black" id="piano-select" name="piano" required>
                            <option value="">Caricamento...</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-3">
                    <label class="w-[35%] font-medium text-sm" for="numero-input">ID</label>
                    <div class="w-[60%]">
                        <input class="w-full bg-iosInputBg border-none rounded-lg py-2 px-3 text-sm text-black placeholder-gray-400" id="numero-input" name="numero" placeholder="Es. ID-1234" type="text" required/>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-3">
                    <label class="w-[35%] font-medium text-sm" for="parete-solaio-select">Parete / Solaio</label>
                    <div class="w-[60%]">
                        <select class="w-full bg-iosInputBg border-none rounded-lg py-2 px-3 text-sm text-black" id="parete-solaio-select" name="parete_solaio" required>
                            <option value="">Caricamento...</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-3">
                    <label class="w-[35%] font-medium text-sm" for="supporto-select">Supporto</label>
                    <div class="w-[60%]">
                        <select class="w-full bg-iosInputBg border-none rounded-lg py-2 px-3 text-sm text-black" id="supporto-select" name="supporto" required>
                            <option value="">Caricamento...</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <label class="w-[35%] font-medium text-sm" for="dimensioni-cm-input">Dimensioni (CM)</label>
                    <div class="w-[60%]">
                        <input class="w-full bg-iosInputBg border-none rounded-lg py-2 px-3 text-sm text-black placeholder-gray-400" id="dimensioni-cm-input" name="dimensioni_cm" placeholder="Es. 10x20" type="text"/>
                    </div>
                </div>
            </section>

            <!-- Dettagli Tecnici -->
            <section class="bg-white rounded-xl p-4 mb-5 shadow-sm">
                <h2 class="font-bold text-lg mb-4">Dettagli Tecnici</h2>
                
                <div id="attraversamenti-container">
                    <!-- Le righe verranno aggiunte qui da JavaScript -->
                </div>

                <div class="flex justify-end items-center gap-4 mt-5">
                    <button type="button" id="add-attraversamento-btn" class="w-11 h-11 rounded-full bg-iosBlue text-white flex items-center justify-center shadow-lg shadow-blue-200 transition-opacity active:opacity-80">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </section>

            <!-- Note Aggiuntive -->
            <section class="bg-white rounded-xl p-4 mb-6 shadow-sm">
                <h2 class="font-bold text-lg mb-3">Note Aggiuntive</h2>
                <textarea id="notes" name="notes" class="w-full bg-iosInputBg border-none rounded-lg p-3 text-sm text-black placeholder-gray-400 h-20 resize-none focus:ring-0" placeholder="Aggiungi dettagli qui..."></textarea>
            </section>

            <!-- Footer Buttons -->
            <footer class="mt-4 mb-8">
                <button type="submit" id="submit-btn" class="w-full bg-iosBlue text-white font-bold text-base py-3.5 rounded-full shadow-md active:opacity-90 transition-opacity">
                    Invia Segnalazione
                </button>
                <button type="button" id="reload-btn" class="w-full block text-center text-iosBlue mt-4 no-underline text-base active:opacity-75 bg-transparent border-none">
                    Ricarica Pagina
                </button>
            </footer>
        </form>
    </main>

    <!-- Camera Overlay -->
    <div id="camera-overlay" class="camera-overlay">
        <div class="camera-container">
            <video id="camera-video" autoplay playsinline></video>
            <div class="overlay-controls">
                <button type="button" id="capture-btn" class="overlay-btn">Scatta</button>
                <button type="button" id="capture-another" class="overlay-btn secondary">Scatta un'altra</button>
                <button type="button" id="cancel-camera" class="overlay-btn secondary">Indietro</button>
            </div>
        </div>
    </div>

    <!-- Main Logic Script -->
    <script>
        // --- CONFIGURAZIONE ---
        const N8N_WEBHOOK_URL = 'https://n8n.fire-block.org/webhook/miniapp';

        // Dati CSV locali (Fallback)
        const PIANO_DATA = ['P -3','P -2','P -1','P 0','P 1','P 2','P 3','P 4','P 5','P 6','P 7','P 8','P 9','P 10','P 11','P 12','P 13','P 14','P 15','P 16','P 17','P 18','P 19','P 20','P 21','P 22','P 23'];
        const PARETE_SOLAIO_DATA = ['Parete','Solaio'];
        const SUPPORTO_DATA = ['Flessibile','Laterizio intonacato','Laterizio non intonacato','CLS','Leca','Cemento armato','Legno'];
        const ATTRAVERSAMENTI_DATA = ['Cavi/Corrugati','Canalina passacavi','Scatola elettrica','Tubo combustibile','Tubo multistrato','Tubo RAME','Tubo incombustibile NUDO','Tubo incombustibile ISOLATO lana','Tubo incombustibile ISOLATO combustibile','Serranda','Barra armata'];
        
        let opzioniPiani = [];
        let opzioniPareteSolaio = [];
        let opzioniAttraversamenti = [];
        let opzioniSupporti = [];

        // Telegram Integration
        let tg;
        try {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
            document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#0088cc');
        } catch (e) {
            console.log('Browser mode active');
        }

        // DOM Elements
        const form = document.getElementById('report-form');
        const submitBtn = document.getElementById('submit-btn');
        const headerSubmitBtn = document.getElementById('header-submit-btn');
        const attraversamentiContainer = document.getElementById('attraversamenti-container');
        const addAttraversamentoBtn = document.getElementById('add-attraversamento-btn');
        const statusDiv = document.getElementById('status');

        // --- Data Fetching Logic ---
        async function fetchData(url) {
            if (!url) throw new Error(`URL non valido: ${url}`);
            const sep = url.includes('?') ? '&' : '?';
            const withBust = `${url}${sep}v=${Date.now()}`;
            const response = await fetch(withBust, { cache: 'no-store' });
            if (!response.ok) throw new Error(`Errore di rete per ${url}`);
            const csvText = await response.text();
            return csvText.split(/\r?\n/)[0].split(',').map(item => item.trim()).filter(item => item);
        }

        async function populateDropdowns() {
            statusDiv.textContent = 'Caricamento dati...';
            try {
                const [piani, pareteSolaio, supporti, attraversamenti] = await Promise.all([
                    fetchData('piani.csv').catch(() => PIANO_DATA),
                    fetchData('ps.csv').catch(() => PARETE_SOLAIO_DATA),
                    fetchData('supporto.csv').catch(() => SUPPORTO_DATA),
                    fetchData('attraversamenti.csv').catch(() => ATTRAVERSAMENTI_DATA)
                ]);

                opzioniPiani = piani;
                opzioniPareteSolaio = pareteSolaio;
                opzioniSupporti = supporti;
                opzioniAttraversamenti = attraversamenti;

                const populate = (id, data, placeholder) => {
                    const select = document.getElementById(id);
                    select.innerHTML = `<option value="">${placeholder}</option>`;
                    data.forEach(item => select.add(new Option(item, item)));
                };

                populate('piano-select', opzioniPiani, 'Seleziona Piano');
                populate('parete-solaio-select', opzioniPareteSolaio, 'Seleziona Parete / Solaio');
                populate('supporto-select', opzioniSupporti, 'Seleziona Supporto');
                
                addAttraversamentoRow(true);
                statusDiv.textContent = '';
            } catch (error) {
                console.error('Errore dati:', error);
                statusDiv.textContent = 'Errore caricamento dati (modalità offline attiva)';
            }
        }

        // --- Dynamic Rows Logic ---
        function addAttraversamentoRow(isFirstRow = false) {
            const newRow = document.createElement('div');
            newRow.className = 'mb-4 pb-4 border-b border-gray-100 last:border-0 attraversamento-row';
            
            const removeBtn = isFirstRow ? '' : `
                <button type="button" class="remove-btn w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center absolute -right-2 -top-2">
                    <i class="fas fa-times"></i>
                </button>
            `;

            newRow.innerHTML = `
                <div class="relative">
                    ${removeBtn}
                    <div class="flex items-center justify-between mb-3">
                        <label class="w-[35%] font-medium text-sm">Attraversamento</label>
                        <div class="w-[60%]">
                            <select class="attraversamento-select w-full bg-iosInputBg border-none rounded-lg py-2 px-3 text-sm text-black" required>
                                <option value="">Seleziona...</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mb-3">
                        <label class="w-[35%] font-medium text-sm">Quantità</label>
                        <div class="w-[60%]">
                            <input type="number" class="quantita-input w-full bg-iosInputBg border-none rounded-lg py-2 px-3 text-sm text-black" placeholder="Qtà" value="1" required>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mb-3">
                        <label class="w-[35%] font-medium text-sm">Dim./Diametro</label>
                        <div class="w-[60%]">
                            <input type="text" class="dimensioni-diametro-input w-full bg-iosInputBg border-none rounded-lg py-2 px-3 text-sm text-black" placeholder="Es: 100mm">
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="w-[35%] font-medium text-sm">N Tipologico</label>
                        <div class="w-[60%]">
                            <input type="number" class="n-tipologico-input w-full bg-iosInputBg border-none rounded-lg py-2 px-3 text-sm text-black" placeholder="Es: 0112">
                        </div>
                    </div>
                </div>
            `;
            
            attraversamentiContainer.appendChild(newRow);
            const select = newRow.querySelector('.attraversamento-select');
            opzioniAttraversamenti.forEach(item => select.add(new Option(item, item)));
        }

        addAttraversamentoBtn.addEventListener('click', () => addAttraversamentoRow());
        attraversamentiContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-btn')) {
                e.target.closest('.attraversamento-row').remove();
            }
        });

        // --- Image Handling Logic ---
        async function resizeImage(file, maxWidth = 1920, maxHeight = 1080, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    let w = img.width, h = img.height;
                    const aspect = w / h;
                    if (w > maxWidth || h > maxHeight) {
                        if (w > h) { w = maxWidth; h = w / aspect; }
                        else { h = maxHeight; w = h * aspect; }
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, w, h);
                    ctx.drawImage(img, 0, 0, w, h);
                    canvas.toBlob(blob => {
                        resolve(new File([blob], file.name.replace(/\.[^/.]+$/, '.jpg'), { type: 'image/jpeg', lastModified: Date.now() }));
                    }, 'image/jpeg', quality);
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // Camera & Gallery Setup
        function setupCameraButtons() {
            const cameraBtn = document.getElementById('camera-btn');
            const galleryBtn = document.getElementById('gallery-btn');
            const photoInput = document.getElementById('photo');
            const overlay = document.getElementById('camera-overlay');
            const videoEl = document.getElementById('camera-video');
            const captureBtn = document.getElementById('capture-btn');
            const cancelBtn = document.getElementById('cancel-camera');

            // Gallery
            galleryBtn.addEventListener('click', () => {
                const tempInput = document.createElement('input');
                tempInput.type = 'file';
                tempInput.accept = 'image/*';
                tempInput.onchange = (e) => handleFileSelect(e.target.files[0]);
                tempInput.click();
            });

            // Camera
            cameraBtn.addEventListener('click', async () => {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                        videoEl.srcObject = stream;
                        overlay.classList.add('active');
                    } catch (e) {
                        console.error("Camera overlay failed, falling back to input", e);
                        const tempInput = document.createElement('input');
                        tempInput.type = 'file';
                        tempInput.accept = 'image/*';
                        tempInput.capture = 'environment';
                        tempInput.onchange = (e) => handleFileSelect(e.target.files[0]);
                        tempInput.click();
                    }
                }
            });

            // Capture from Overlay
            captureBtn.addEventListener('click', async () => {
                const canvas = document.createElement('canvas');
                canvas.width = videoEl.videoWidth;
                canvas.height = videoEl.videoHeight;
                canvas.getContext('2d').drawImage(videoEl, 0, 0);
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
                    await handleFileSelect(file);
                    stopCamera();
                }, 'image/jpeg', 0.85);
            });

            cancelBtn.addEventListener('click', stopCamera);

            function stopCamera() {
                overlay.classList.remove('active');
                if (videoEl.srcObject) {
                    videoEl.srcObject.getTracks().forEach(t => t.stop());
                    videoEl.srcObject = null;
                }
            }

            async function handleFileSelect(file) {
                if (!file) return;
                statusDiv.textContent = 'Elaborazione foto...';
                try {
                    const processed = await resizeImage(file);
                    const dt = new DataTransfer();
                    dt.items.add(processed);
                    photoInput.files = dt.files;
                    
                    // Preview
                    const preview = document.getElementById('photo-preview');
                    preview.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(processed);
                    img.className = 'rounded-lg max-h-48 mx-auto';
                    preview.appendChild(img);
                    
                    statusDiv.textContent = 'Foto allegata con successo';
                    statusDiv.classList.remove('text-red-500');
                    statusDiv.classList.add('text-green-500');
                } catch (e) {
                    console.error(e);
                    statusDiv.textContent = 'Errore elaborazione foto';
                    statusDiv.classList.add('text-red-500');
                }
            }
        }

        // --- Form Submission ---
        async function handleSubmit(e) {
            if (e) e.preventDefault();
            
            // Validation
            const required = form.querySelectorAll('[required]');
            let valid = true;
            required.forEach(el => {
                if (!el.value) {
                    el.classList.add('border-red-500');
                    valid = false;
                } else {
                    el.classList.remove('border-red-500');
                }
            });

            if (!valid) {
                statusDiv.textContent = 'Compila tutti i campi obbligatori';
                statusDiv.classList.add('text-red-500');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Invio in corso...';
            statusDiv.textContent = 'Invio in corso...';

            try {
                const formData = new FormData(form);
                
                // Add Telegram User
                formData.append('telegramUser', tg ? JSON.stringify(tg.initDataUnsafe?.user) : '');
                formData.append('timestamp', new Date().toISOString());

                // Collect Attraversamenti
                const attraversamenti = [];
                document.querySelectorAll('.attraversamento-row').forEach(row => {
                    const select = row.querySelector('.attraversamento-select');
                    if (select.value) {
                        attraversamenti.push({
                            tipo: select.value,
                            quantita: row.querySelector('.quantita-input').value,
                            dimensioni: row.querySelector('.dimensioni-diametro-input').value,
                            n_tipologico: row.querySelector('.n-tipologico-input').value
                        });
                    }
                });
                formData.append('attraversamenti', JSON.stringify(attraversamenti));

                // Add flat fields for backward compatibility if needed
                if (attraversamenti.length > 0) {
                    formData.append('tipo', attraversamenti[0].tipo);
                    formData.append('quantita', attraversamenti[0].quantita);
                    formData.append('dimensioni', attraversamenti[0].dimensioni);
                    formData.append('n_tipologico', attraversamenti[0].n_tipologico);
                }

                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 30000);

                const res = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                clearTimeout(timeout);

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                statusDiv.textContent = 'Report inviato con successo!';
                statusDiv.classList.add('text-green-500');
                form.reset();
                document.getElementById('photo-preview').innerHTML = '';
                addAttraversamentoRow(true); // Reset rows
                
                if (tg) tg.close();

            } catch (error) {
                console.error(error);
                statusDiv.textContent = 'Errore durante l\'invio. Riprova.';
                statusDiv.classList.add('text-red-500');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Invia Segnalazione';
            }
        }

        form.addEventListener('submit', handleSubmit);
        headerSubmitBtn.addEventListener('click', () => form.requestSubmit());
        document.getElementById('reload-btn').addEventListener('click', () => window.location.reload());

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            populateDropdowns();
            setupCameraButtons();
        });
    </script>
</body>
</html>