<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireBlock MiniApp â€¢ Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-button: var(--tg-theme-button-color, #007bff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        body { margin:0; padding:20px; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif; background:var(--tg-bg); color:var(--tg-text); }
        .wrapper { max-width:640px; margin:0 auto; }
        h1 { margin:0 0 10px; font-size:22px; text-align:center; }
        p { color:var(--tg-hint); text-align:center; }
        .card { background:var(--tg-secondary); border:1px solid var(--tg-hint); border-radius:12px; padding:16px; margin-top:16px; }
        .btn { width:100%; padding:14px 16px; border:none; border-radius:10px; background:var(--tg-button); color:var(--tg-button-text); font-weight:600; cursor:pointer; }
        .btn:active { transform:translateY(1px); }
        .welcome { text-align:center; margin-bottom:12px; font-weight:600; }
        .small { font-size:12px; color:var(--tg-hint); text-align:center; margin-top:8px; }
    </style>
</head>
<body>
    <div class="wrapper">
        <h1>FireBlock MiniApp</h1>
        <div id="welcome" class="welcome">Benvenuto!</div>
        <div class="card">
            <p>Per utilizzare la fotocamera con la migliore esperienza, apri la versione browser.</p>
            <button id="open-browser" class="btn">Apri nel browser</button>
            <div id="hint" class="small"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
        const welcomeEl = document.getElementById('welcome');
        const hintEl = document.getElementById('hint');
        const openBtn = document.getElementById('open-browser');
        const appUrl = new URL('./app.html', location.href).toString();

        function applyTheme() {
            if (!tg) return;
            const p = tg.themeParams || {};
            document.documentElement.style.setProperty('--tg-theme-bg-color', p.bg_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-text-color', p.text_color || '#000000');
            document.documentElement.style.setProperty('--tg-theme-hint-color', p.hint_color || '#999999');
            document.documentElement.style.setProperty('--tg-theme-button-color', p.button_color || '#0088cc');
            document.documentElement.style.setProperty('--tg-theme-button-text-color', p.button_text_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', p.secondary_bg_color || '#f0f0f0');
        }

        function setupMainButton() {
            if (!tg) return;
            tg.MainButton.setText('Apri nel browser');
            tg.MainButton.show();
            tg.MainButton.onClick(() => {
                tg.HapticFeedback?.impactOccurred('soft');
                tg.openLink(appUrl);
                try { tg.CloudStorage?.setItem('opened_app', Date.now().toString()); } catch (e) {}
            });
        }

        function setupWelcome() {
            let name = '';
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const u = tg.initDataUnsafe.user;
                name = [u.first_name, u.last_name].filter(Boolean).join(' ');
                const un = u.username ? ` (@${u.username})` : '';
                welcomeEl.textContent = `Benvenuto, ${name}${un}!`;
            } else {
                welcomeEl.textContent = 'Benvenuto!';
            }
        }

        function setupButton() {
            openBtn.addEventListener('click', () => {
                if (tg) {
                    tg.HapticFeedback?.impactOccurred('soft');
                    tg.openLink(appUrl);
                    try { tg.CloudStorage?.setItem('opened_app', Date.now().toString()); } catch (e) {}
                } else {
                    window.open(appUrl, '_blank');
                }
            });
        }

        function showLastOpenHint() {
            if (!tg || !tg.CloudStorage) return;
            try {
                tg.CloudStorage.getItem('opened_app', (err, value) => {
                    if (!err && value) {
                        const d = new Date(parseInt(value, 10));
                        hintEl.textContent = `Ultima apertura: ${d.toLocaleString()}`;
                    }
                });
            } catch (_) {}
        }

        (function init() {
            if (tg) {
                tg.ready();
                tg.expand();
            }
            applyTheme();
            setupWelcome();
            setupButton();
            setupMainButton();
            showLastOpenHint();
        })();
    </script>
</body>
</html>